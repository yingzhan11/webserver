<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Language -->
    <meta charset="UTF-8">
    <!-- Responsiveness -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!-- Defines -->
    <link rel="canonical" href="https://www.site1/index.html" />
    <link rel="shortcut icon" href="/favicon.ico">
    <title>Delete Files - Webserver</title>
    <!-- Style -->
    <link rel="stylesheet" href="/styles.css">
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=Major+Mono+Display&display=swap"
        rel="stylesheet">
</head>

<body>

    <div class="container-top">

        <header>
            <h2 class="site-logo">Webserver</h2>
            <h5 class="site-slogan">This is when you finally understand why a URL starts with HTTP</h5>
            <nav>
                <ul>
                    <li><a href="/index.html">Home</a></li>
                    <li><a href="/testcmd.html">TestCMD</a></li>
                    <li><a href="/upload.html">Upload</a></li>
                    <li><a href="/delete.html">Delete</a></li>
                    <li><a href="/cgiget.html">CGI-GET</a></li>
                </ul>
            </nav>
        </header>

        <div class="main-content">
            <h3 class="title">Delete Uploaded Files</h3>
            <p class="general-paragraph">
                Type the file name or click one from the list to delete it permanently from the server.
            </p>

            <form id="delete-form">
                <input type="text" name="filename" id="filename" class="input-text" placeholder="e.g. bus.jpg" required>
                <button type="submit" class="button-link">DELETE</button>
            </form>

            <h4 class="subtitle">Uploaded Files:</h4>
            <div id="file-list" class="file-list">
                <p>Loading...</p>
            </div>
        </div>

        <footer>
            <p>Webserver @ 2025</p>
        </footer>

    </div>

    <script>
        let uploadBase = "/upload"; // default

        async function tryFetch(url) {
            try {
                const res = await fetch(url);
                if (res.ok) return res;
                throw new Error("Status " + res.status);
            } catch {
                return null;
            }
        }

        async function loadFileList() {
            const listDiv = document.getElementById('file-list');
            listDiv.innerHTML = '<p>Loading...</p>';

            // try both /uploads/ and /upload/
            let res = await tryFetch('/upload/');
            if (!res) {
                res = await tryFetch('/upload/');
                if (res) uploadBase = "/upload";
            }

            if (!res) {
                listDiv.innerHTML = '<p>‚ö†Ô∏è Cannot access upload directory.</p>';
                return;
            }

            const html = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const links = Array.from(doc.querySelectorAll('a'))
                .map(a => a.getAttribute('href'))
                .filter(href => href && !href.endsWith('/') && href !== '../');

            if (links.length === 0) {
                listDiv.innerHTML = '<p>No uploaded files found.</p>';
                return;
            }

            // only show filename (remove path)
            const names = links.map(href => href.split('/').pop());

            listDiv.innerHTML = '<ul>' +
                names.map(f => `<li><a onclick="selectFile('${f}')">${f}</a></li>`).join('') +
                '</ul>';
        }

        function selectFile(filename) {
            const input = document.getElementById('filename');
            input.value = filename;
            input.focus();
        }

        document.getElementById('delete-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const filename = document.getElementById('filename').value.trim();
            if (!filename) return alert("Please enter a filename.");

            if (!confirm(`Are you sure you want to delete "${filename}"?`)) return;

            const url = `${uploadBase}/${encodeURIComponent(filename)}`;
            try {
                const res = await fetch(url, { method: 'DELETE' });
                if (res.ok) {
                    alert(`‚úÖ "${filename}" deleted successfully!`);
                    loadFileList();
                } else if (res.status === 404) {
                    alert(`‚ùå File not found.`);
                } else if (res.status === 403) {
                    alert(`üö´ Permission denied.`);
                } else {
                    alert(`‚ö†Ô∏è Delete failed. Status: ${res.status}`);
                }
            } catch (err) {
                alert("Network error: " + err.message);
            }
        });

        window.addEventListener('DOMContentLoaded', loadFileList);
    </script>

</body>
</html>
